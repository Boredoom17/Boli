<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Boli ‚Äî ‡§¨‡•ã‡§≤‡•Ä</title>
    <link href="https://fonts.googleapis.com/css2?family=Tiro+Devanagari+Nepali:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    
    <style>
        :root {
            --red:       #8B1A1A;
            --red-light: #B22222;
            --cream:     #F5EFE0;
            --cream-dark:#EDE4D0;
            --ink:       #1C1008;
            --ink-soft:  #4A3728;
            --gold:      #C9922A;
            --green:     #2D6A4F;
            --green-light: #3a8a65;
            --white:     #FDFAF4;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--cream);
            color: var(--ink);
            font-family: 'DM Sans', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            background: var(--red);
            padding: 18px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo { display: flex; flex-direction: column; line-height: 1; }
        .logo-main { font-family: 'Tiro Devanagari Nepali', serif; font-size: 26px; font-weight: 500; color: var(--cream); letter-spacing: 2px; }
        .logo-sub { font-size: 10px; color: rgba(245,239,224,0.65); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 3px; font-family: 'DM Mono', monospace; }

        .user-pill {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255,255,255,0.12); border-radius: 99px;
            padding: 6px 12px 6px 6px; cursor: pointer; transition: background 0.2s;
        }
        .user-pill:hover { background: rgba(255,255,255,0.2); }

        .user-avatar {
            width: 28px; height: 28px; border-radius: 50%;
            background: var(--gold); display: flex; align-items: center;
            justify-content: center; font-size: 13px; font-weight: 600;
            color: var(--white); overflow: hidden;
        }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-name { font-size: 13px; color: var(--cream); font-weight: 500; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        main {
            width: 100%; max-width: 480px; padding: 0 16px 48px;
            flex: 1; display: flex; flex-direction: column; margin: 0 auto;
        }

        /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
        .screen { display: none; }
        .screen.active { display: block; }
        #done-screen.active { display: flex; flex-direction: column; }
        /* Show login by default until Firebase decides */
        #login-screen { display: block; }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        #login-screen { padding-top: 40px; text-align: center; }

        .nepali-title { font-family: 'Tiro Devanagari Nepali', serif; font-size: 64px; color: var(--red); margin-bottom: 2px; line-height: 1.1; }
        .eng-title { font-family: 'DM Mono', monospace; font-size: 12px; letter-spacing: 3px; text-transform: uppercase; color: var(--ink-soft); margin-bottom: 16px; }

        .login-card { background: var(--white); border-radius: 20px; padding: 32px 28px; box-shadow: 0 4px 32px rgba(0,0,0,0.08); width: 100%; }
        .login-card h2 { font-size: 18px; font-weight: 600; margin-bottom: 6px; }
        .login-card p { font-size: 13px; color: var(--ink-soft); line-height: 1.6; margin-bottom: 24px; }

        .google-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 13px; background: var(--red); color: var(--cream);
            border: none; border-radius: 12px; font-size: 15px; font-weight: 500;
            cursor: pointer; transition: background 0.2s, transform 0.1s; font-family: 'DM Sans', sans-serif;
        }
        .google-btn:hover { background: var(--red-light); }
        .google-btn:active { transform: scale(0.98); }

        /* ‚îÄ‚îÄ IN-APP BROWSER WARNING ‚îÄ‚îÄ */
        #iab-screen { padding-top: 60px; text-align: center; }
        .iab-icon { font-size: 56px; margin-bottom: 16px; }
        .iab-card { background: var(--white); border-radius: 20px; padding: 32px 24px; box-shadow: 0 4px 32px rgba(0,0,0,0.08); }
        .iab-card h2 { font-size: 18px; font-weight: 600; margin-bottom: 10px; color: var(--ink); }
        .iab-card p { font-size: 13px; color: var(--ink-soft); line-height: 1.7; margin-bottom: 20px; }
        .iab-url { background: var(--cream-dark); border-radius: 10px; padding: 12px 16px; font-family: 'DM Mono', monospace; font-size: 12px; color: var(--ink); margin-bottom: 20px; word-break: break-all; }
        .iab-copy-btn { width: 100%; padding: 13px; background: var(--red); color: var(--cream); border: none; border-radius: 12px; font-size: 15px; font-weight: 500; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: background 0.2s; }
        .iab-copy-btn:hover { background: var(--red-light); }
        .iab-steps { text-align: left; margin-top: 20px; border-top: 1px solid var(--cream-dark); padding-top: 16px; }
        .iab-step { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px; font-size: 13px; color: var(--ink-soft); line-height: 1.5; }
        .iab-step-num { background: var(--red); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; min-width: 20px; margin-top: 1px; }

        /* ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ */
        #welcome-screen { padding-top: 24px; }

        .welcome-banner { background: var(--red); border-radius: 20px; padding: 28px; color: var(--cream); margin-bottom: 16px; }
        .welcome-banner .greeting { font-size: 13px; opacity: 0.7; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
        .welcome-banner .speaker-name { font-size: 26px; font-weight: 600; margin-bottom: 12px; }
        .welcome-banner .instructions { font-size: 13px; line-height: 1.7; opacity: 0.85; }

        .instructions-card {
            background: var(--white); border-radius: 20px; padding: 20px 20px 16px;
            margin-bottom: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        .card-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; color: var(--ink-soft); margin-bottom: 14px; font-family: 'DM Mono', monospace; }

        .tip-row { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
        .tip-row:last-child { margin-bottom: 0; }
        .tip-icon { font-size: 18px; min-width: 26px; text-align: center; margin-top: 1px; }
        .tip-text { font-size: 13px; color: var(--ink-soft); line-height: 1.6; }
        .tip-text strong { color: var(--ink); }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .info-box { background: var(--white); border-radius: 14px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .info-box .label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--ink-soft); margin-bottom: 4px; }
        .info-box .value { font-size: 22px; font-weight: 700; color: var(--red); font-family: 'DM Mono', monospace; }
        .info-box .value-sub { font-size: 11px; color: var(--ink-soft); margin-top: 2px; }

        .start-btn {
            width: 100%; padding: 16px; background: var(--red); color: var(--cream);
            border: none; border-radius: 14px; font-size: 17px; font-weight: 600;
            cursor: pointer; font-family: 'DM Sans', sans-serif;
            transition: background 0.2s, transform 0.1s; letter-spacing: 0.5px;
        }
        .start-btn:hover { background: var(--red-light); }
        .start-btn:active { transform: scale(0.98); }

        .footer-text { font-size: 12px; color: var(--ink-soft); text-align: center; margin-top: 24px; opacity: 0.8; line-height: 1.4; }

        /* ‚îÄ‚îÄ STAGE / WORD SELECTION ‚îÄ‚îÄ */
        #stage-screen { padding-top: 24px; }

        .stage-header { margin-bottom: 20px; }
        .stage-title-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .stage-title { font-size: 20px; font-weight: 600; }
        .stage-overall {
            font-family: 'DM Mono', monospace; font-size: 12px;
            color: var(--ink-soft); background: var(--white);
            padding: 6px 12px; border-radius: 99px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.06);
        }

        .overall-bar-wrap { background: var(--cream-dark); border-radius: 99px; height: 8px; overflow: hidden; margin-bottom: 6px; }
        .overall-bar-fill { height: 100%; background: var(--green); border-radius: 99px; transition: width 0.5s ease; }
        .overall-bar-label { font-size: 11px; color: var(--ink-soft); text-align: right; }

        /* Word grid */
        .word-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .word-tile {
            background: var(--white);
            border-radius: 16px;
            padding: 16px 14px 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s, border-color 0.2s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .word-tile:hover:not(.completed) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            border-color: var(--red);
        }

        .word-tile.completed {
            border-color: var(--green);
            cursor: default;
        }

        .word-tile.in-progress {
            border-color: var(--gold);
        }

        .word-tile.completed::after {
            content: '‚úì';
            position: absolute;
            top: 10px; right: 12px;
            font-size: 14px; font-weight: 700;
            color: var(--green);
        }

        .tile-nepali {
            font-family: 'Tiro Devanagari Nepali', serif;
            font-size: 26px; color: var(--red); line-height: 1.1;
            margin-bottom: 2px;
        }

        .tile-roman {
            font-family: 'DM Mono', monospace;
            font-size: 11px; color: var(--gold);
            letter-spacing: 0.5px; margin-bottom: 2px;
        }

        .tile-meaning {
            font-size: 11px; color: var(--ink-soft);
            margin-bottom: 10px;
        }

        .tile-progress-wrap {
            background: var(--cream-dark);
            border-radius: 99px; height: 5px; overflow: hidden;
            margin-bottom: 5px;
        }

        .tile-progress-fill {
            height: 100%; border-radius: 99px;
            transition: width 0.4s ease;
        }

        .tile-progress-fill.done { background: var(--green); }
        .tile-progress-fill.partial { background: var(--gold); }

        .tile-progress-label {
            font-family: 'DM Mono', monospace;
            font-size: 10px; color: var(--ink-soft);
        }

        .stage-all-done {
            background: var(--green);
            color: white;
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            font-size: 15px;
            line-height: 1.6;
            display: none;
            margin-bottom: 16px;
        }

        /* ‚îÄ‚îÄ RECORDER ‚îÄ‚îÄ */
        #recorder-screen { padding-top: 24px; }

        .recorder-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }

        .back-btn {
            display: flex; align-items: center; gap: 6px;
            background: none; border: none; cursor: pointer;
            font-size: 13px; color: var(--ink-soft); font-family: 'DM Sans', sans-serif;
            padding: 4px 0; transition: color 0.2s;
        }
        .back-btn:hover { color: var(--red); }

        .progress-bar-wrap { background: var(--cream-dark); border-radius: 99px; height: 6px; margin-bottom: 24px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--red); border-radius: 99px; transition: width 0.4s ease; }
        .progress-label { font-size: 11px; color: var(--ink-soft); letter-spacing: 0.5px; text-align: right; margin-bottom: 8px; }

        .word-card {
            background: var(--white); border-radius: 24px; padding: 36px 28px 28px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.07); text-align: center; margin-bottom: 20px;
        }
        .word-number { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--ink-soft); margin-bottom: 12px; font-family: 'DM Mono', monospace; }
        .word-nepali { font-family: 'Tiro Devanagari Nepali', serif; font-size: 52px; color: var(--red); line-height: 1.1; margin-bottom: 8px; }
        .word-romanized { font-family: 'DM Mono', monospace; font-size: 16px; color: var(--gold); margin-bottom: 4px; letter-spacing: 1px; }
        .word-meaning { font-size: 13px; color: var(--ink-soft); margin-bottom: 24px; }

        .attempts-row { display: flex; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .attempt-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--cream-dark); transition: background 0.3s; }
        .attempt-dot.done { background: var(--green); }
        .attempt-dot.active { background: var(--gold); transform: scale(1.3); }
        .attempts-label { font-size: 11px; color: var(--ink-soft); letter-spacing: 0.5px; }

        /* Completed word overlay */
        .word-completed-banner {
            display: none;
            background: var(--green);
            border-radius: 12px;
            padding: 16px 20px;
            color: white;
            text-align: center;
            margin-bottom: 16px;
        }
        .word-completed-banner.show { display: block; }
        .word-completed-banner strong { display: block; font-size: 18px; margin-bottom: 4px; }
        .word-completed-banner span { font-size: 13px; opacity: 0.9; }

        .controls { display: flex; flex-direction: column; align-items: center; gap: 16px; }

        .record-btn {
            width: 80px; height: 80px; border-radius: 50%; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 32px; transition: transform 0.15s, box-shadow 0.2s;
        }
        .record-btn.idle { background: var(--red); box-shadow: 0 4px 20px rgba(139,26,26,0.35); }
        .record-btn.recording { background: #c0392b; animation: pulse-ring 1.2s ease-out infinite; }
        .record-btn:active { transform: scale(0.93); }
        .record-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        @keyframes pulse-ring {
            0%   { box-shadow: 0 0 0 0 rgba(192,57,43,0.5); }
            70%  { box-shadow: 0 0 0 20px rgba(192,57,43,0); }
            100% { box-shadow: 0 0 0 0 rgba(192,57,43,0); }
        }

        .record-hint { font-size: 12px; color: var(--ink-soft); text-align: center; min-height: 18px; }

        .playback-row { display: flex; gap: 10px; align-items: center; }

        .small-btn {
            padding: 9px 18px; border-radius: 99px; border: 2px solid var(--cream-dark);
            background: var(--white); font-size: 13px; font-weight: 500; cursor: pointer;
            color: var(--ink); font-family: 'DM Sans', sans-serif; transition: all 0.15s;
            display: flex; align-items: center; gap: 6px;
        }
        .small-btn:hover { border-color: var(--red); color: var(--red); }
        .small-btn.primary { background: var(--green); border-color: var(--green); color: white; }
        .small-btn.primary:hover { background: #235c43; border-color: #235c43; }
        .small-btn.gold { background: var(--gold); border-color: var(--gold); color: white; }
        .small-btn.gold:hover { background: #b07d1e; border-color: #b07d1e; }
        .small-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .back-to-stage-btn {
            width: 100%; padding: 14px; background: var(--white);
            color: var(--ink); border: 2px solid var(--cream-dark);
            border-radius: 12px; font-size: 15px; font-weight: 500;
            cursor: pointer; font-family: 'DM Sans', sans-serif;
            transition: all 0.2s; margin-top: 8px;
        }
        .back-to-stage-btn:hover { border-color: var(--red); color: var(--red); }

        .upload-indicator { display: none; align-items: center; gap: 8px; font-size: 12px; color: var(--gold); }
        .upload-indicator.show { display: flex; }

        .spinner { width: 14px; height: 14px; border: 2px solid var(--cream-dark); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ DONE ‚îÄ‚îÄ */
        #done-screen {
            align-items: center; justify-content: center;
            min-height: calc(100vh - 72px); text-align: center; gap: 20px;
            padding-top: 40px;
        }

        .done-icon { width: 80px; height: 80px; background: var(--green); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px; box-shadow: 0 4px 20px rgba(45,106,79,0.3); }
        .done-title { font-family: 'Tiro Devanagari Nepali', serif; font-size: 32px; color: var(--red); }
        .done-sub { font-size: 14px; color: var(--ink-soft); line-height: 1.7; max-width: 300px; }

        .done-stats { background: var(--white); border-radius: 16px; padding: 20px 28px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); width: 100%; max-width: 300px; }
        .done-stats .stat-row { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; border-bottom: 1px solid var(--cream-dark); }
        .done-stats .stat-row:last-child { border-bottom: none; }
        .done-stats .stat-val { font-weight: 600; color: var(--green); font-family: 'DM Mono', monospace; }

        .done-ok-btn {
            padding: 14px 40px; background: var(--red); color: var(--cream);
            border: none; border-radius: 12px; font-size: 16px; font-weight: 600;
            cursor: pointer; font-family: 'DM Sans', sans-serif;
            transition: background 0.2s, transform 0.1s;
        }
        .done-ok-btn:hover { background: var(--red-light); }
        .done-ok-btn:active { transform: scale(0.97); }

        /* ‚îÄ‚îÄ Toast & Modal ‚îÄ‚îÄ */
        .toast {
            position: fixed; bottom: 24px; left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--ink); color: var(--cream);
            padding: 10px 20px; border-radius: 99px; font-size: 13px;
            transition: transform 0.3s ease; z-index: 999; white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        #logout-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-content { background: var(--white); border-radius: 16px; padding: 20px; text-align: center; max-width: 300px; width: 80%; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .modal-content p { font-size: 15px; margin-bottom: 16px; }
        .modal-btns { display: flex; gap: 12px; justify-content: center; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; border: none; font-family: 'DM Sans', sans-serif; }
        .modal-cancel { background: var(--cream-dark); color: var(--ink); }
        .modal-logout { background: var(--red); color: var(--cream); }
        .modal-btn:hover { opacity: 0.9; }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <span class="logo-main">‡§¨‡•ã‡§≤‡•Ä</span>
        <span class="logo-sub">Boli ‚Äî Voice Dataset</span>
    </div>
    <div class="user-pill" id="user-pill" style="display:none" onclick="showLogoutModal()">
        <div class="user-avatar" id="user-avatar">?</div>
        <span class="user-name" id="user-name-header">‚Äî</span>
    </div>
</header>

<main>

    <!-- LOGIN -->
    <div id="login-screen" class="screen">
        <div class="nepali-title">‡§¨‡•ã‡§≤‡•Ä</div>
        <div class="eng-title">Boli ¬∑ Voice Collection</div>
        <div class="login-card">
            <h2>‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç / Sign In</h2>
            <p>NepSpot ‡§Ö‡§®‡•Å‡§∏‡§®‡•ç‡§ß‡§æ‡§®‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡•ß‡•® ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§∂‡§¨‡•ç‡§¶‡§π‡§∞‡•Ç ‡§∞‡•á‡§ï‡§∞‡•ç‡§° ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§<br/>Record 12 Nepali keywords for NepSpot research.</p>
            <button class="google-btn" onclick="signInWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.6 32.4 29.2 35 24 35c-6.1 0-11-4.9-11-11s4.9-11 11-11c2.8 0 5.3 1 7.2 2.7l5.7-5.7C33.5 7.1 29 5 24 5 12.9 5 4 13.9 4 25s8.9 20 20 20 20-8.9 20-20c0-1.5-.2-3-.4-4.5z"/>
                    <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.5 16 19 13 24 13c2.8 0 5.3 1 7.2 2.7l5.7-5.7C33.5 7.1 29 5 24 5 16.3 5 9.7 9 6.3 14.7z"/>
                    <path fill="#4CAF50" d="M24 45c5 0 9.5-1.9 12.9-5l-6-5.1C29.2 36.5 26.7 37.5 24 37.5c-5.2 0-9.6-3.5-11.2-8.3l-6.5 5C9.7 41.1 16.3 45 24 45z"/>
                    <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-.8 2.3-2.3 4.3-4.3 5.7l6 5.1C41.1 36.2 44 31 44 25c0-1.5-.2-3-.4-4.5z"/>
                </svg>
                Google ‡§¨‡§æ‡§ü ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
            </button>
        </div>
    </div>

    <!-- IN-APP BROWSER WARNING -->
    <div id="iab-screen" class="screen">
        <div class="iab-icon">üåê</div>
        <div class="iab-card">
            <h2>Open in your browser</h2>
            <p>Instagram and Messenger's built-in browser doesn't support Google Sign-In. Please open this link in <strong>Chrome, Safari, or Firefox</strong> to continue.</p>
            <div class="iab-url" id="iab-url-display">boli.netlify.app</div>
            <button class="iab-copy-btn" onclick="openInBrowser()">üåê Open in Browser</button>
            <button class="iab-copy-btn" onclick="copyLink()" style="margin-top:10px;background:none;border:2px solid var(--cream-dark);color:var(--ink);">üìã Copy link instead</button>
            <div class="iab-steps">
                <div class="iab-step"><div class="iab-step-num">!</div><span>If the button above doesn't work, tap the <strong>‚ãØ menu</strong> at the top right and choose <strong>"Open in browser"</strong></span></div>
            </div>
        </div>
    </div>

    <!-- WELCOME -->
    <div id="welcome-screen" class="screen">
        <div class="welcome-banner">
            <div class="greeting">‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§õ / Welcome</div>
            <div class="speaker-name" id="welcome-name">‚Äî</div>
            <div class="instructions">
                ‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§Ü‡§µ‡§æ‡§ú NepSpot AI ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§Æ‡§π‡§§‡•ç‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§õ‡•§ ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!<br/>
                Your voice helps build Nepali AI. Thank you for contributing!
            </div>
        </div>

        <div class="instructions-card">
            <div class="card-title">üìã How it works</div>
            <div class="tip-row">
                <div class="tip-icon">üè†</div>
                <div class="tip-text"><strong>Find a quiet spot.</strong> A room with no background noise or music is best. Don't record near a fan or open window.</div>
            </div>
            <div class="tip-row">
                <div class="tip-icon">üéôÔ∏è</div>
                <div class="tip-text"><strong>Hold your phone normally</strong> ‚Äî about 15‚Äì20 cm from your mouth. Don't cover the mic or hold it too close.</div>
            </div>
            <div class="tip-row">
                <div class="tip-icon">üó£Ô∏è</div>
                <div class="tip-text"><strong>Speak clearly and naturally.</strong> Say each word the way you'd normally say it ‚Äî not too slow, not robotic. Vary your pace slightly across attempts.</div>
            </div>
            <div class="tip-row">
                <div class="tip-icon">‚è±Ô∏è</div>
                <div class="tip-text"><strong>Wait 1 second</strong> before and after speaking. Press record ‚Üí pause ‚Üí say the word ‚Üí pause ‚Üí stop.</div>
            </div>
            <div class="tip-row">
                <div class="tip-icon">üîá</div>
                <div class="tip-text"><strong>Don't shout.</strong> Normal talking volume is perfect. Shouting distorts the audio.</div>
            </div>
            <div class="tip-row">
                <div class="tip-icon">‚òï</div>
                <div class="tip-text"><strong>Tired? Take a break anytime.</strong> Your progress auto-saves. Come back and pick up any word you haven't finished.</div>
            </div>
            <div class="tip-row">
                <div class="tip-icon">üîÅ</div>
                <div class="tip-text"><strong>Not happy with a recording?</strong> Hit ‚Ü∫ to retake before saving.</div>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-box"><div class="label">Words</div><div class="value">12</div><div class="value-sub">Nepali</div></div>
            <div class="info-box"><div class="label">Repeat</div><div class="value">10√ó</div><div class="value-sub">per word</div></div>
            <div class="info-box"><div class="label">Total</div><div class="value">120</div><div class="value-sub">clips</div></div>
            <div class="info-box"><div class="label">Time</div><div class="value">~15</div><div class="value-sub">‡§Æ‡§ø‡§®‡•á‡§ü</div></div>
        </div>

        <button class="start-btn" onclick="goToStage()">‡§∏‡•Å‡§∞‡•Å ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‚Üí</button>

        <div class="footer-text">
            Thanks for the help guys :)<br>
            -Aadarsha
        </div>
    </div>

    <!-- STAGE / WORD SELECTION -->
    <div id="stage-screen" class="screen">
        <div class="stage-header">
            <div class="stage-title-row">
                <button class="back-btn" onclick="goBackToWelcome()" style="margin-bottom:0">‚Üê Home</button>
                <div class="stage-overall" id="stage-overall-label">0 / 12 done</div>
            </div>
            <div class="stage-title" style="margin-bottom:8px">‡§∂‡§¨‡•ç‡§¶‡§π‡§∞‡•Ç / Words</div>
            <div class="overall-bar-wrap">
                <div class="overall-bar-fill" id="overall-bar" style="width:0%"></div>
            </div>
            <div class="overall-bar-label" id="overall-bar-label">0 / 120 clips recorded</div>
        </div>

        <!-- All-done banner (shown when all 12 words complete) -->
        <div class="stage-all-done" id="stage-all-done">
            üéâ Thank you for helping me create a dataset. Your help will be valuable!<br>
            <button class="done-ok-btn" style="margin-top:14px" onclick="showFinalDone()">OK</button>
        </div>

        <div class="word-grid" id="word-grid"></div>
    </div>

    <!-- RECORDER -->
    <div id="recorder-screen" class="screen">
        <div class="recorder-header">
            <button class="back-btn" onclick="goBackToStage()">‚Üê Word list</button>
            <span class="progress-label" id="progress-text">Attempt 1 of 10</span>
        </div>
        <div class="progress-bar-wrap">
            <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
        </div>

        <!-- Shown when a word is fully done -->
        <div class="word-completed-banner" id="word-completed-banner">
            <strong>‚úì Word Complete!</strong>
            <span>All 10 attempts saved for this word.</span>
        </div>

        <div class="word-card">
            <div class="word-number" id="word-number">WORD 1 / 12</div>
            <div class="word-nepali" id="word-nepali">‚Äî</div>
            <div class="word-romanized" id="word-romanized">‚Äî</div>
            <div class="word-meaning" id="word-meaning">‚Äî</div>
            <div class="attempts-row" id="attempts-row"></div>
            <div class="attempts-label" id="attempts-label">Attempt 1 of 10</div>
        </div>

        <div class="controls">
            <button class="record-btn idle" id="record-btn" onclick="toggleRecord()">üéô</button>
            <div class="record-hint" id="record-hint">‡§•‡§ø‡§ö‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§∞ ‡§¨‡•ã‡§≤‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</div>
            <div class="playback-row" id="playback-row" style="display:none">
                <button class="small-btn" onclick="playBack()">‚ñ∂ ‡§∏‡•Å‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
                <button class="small-btn" onclick="retake()">‚Ü∫ ‡§´‡•á‡§∞‡§ø</button>
                <button class="small-btn primary" id="save-btn" onclick="saveClip()">‚úì ‡§∞‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§õ</button>
            </div>
            <div class="upload-indicator" id="upload-indicator">
                <div class="spinner"></div><span>Uploading‚Ä¶</span>
            </div>
            <button class="back-to-stage-btn" id="back-to-stage-from-recorder" onclick="goBackToStage()">‚Üê Back to word list</button>
        </div>
    </div>

    <!-- DONE (final thank you) -->
    <div id="done-screen" class="screen">
        <div class="done-icon">‚úì</div>
        <div class="done-title">‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!</div>
        <div class="done-sub">Thank you for helping me create a dataset. Your help will be valuable.</div>
        <div class="done-stats" id="done-stats"></div>
        <button class="done-ok-btn" onclick="handleDoneOK()">OK</button>
    </div>

</main>

<div class="toast" id="toast"></div>

<div id="logout-modal">
    <div class="modal-content">
        <p>Sign out of Boli?</p>
        <div class="modal-btns">
            <button class="modal-btn modal-cancel" onclick="hideLogoutModal()">Cancel</button>
            <button class="modal-btn modal-logout" onclick="handleSignOut()">Logout</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* ‚îÄ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ */
    const keywords = [
        { nepali: "‡§¨‡§æ‡§≤‡•ç‡§®‡•Å",    romanized: "baalnu",    meaning: "Turn On" },
        { nepali: "‡§¨‡§®‡•ç‡§¶",      romanized: "banda",     meaning: "Turn Off" },
        { nepali: "‡§∏‡•Å‡§∞‡•Å",      romanized: "suru",      meaning: "Start" },
        { nepali: "‡§∞‡•ã‡§ï‡•ç‡§®‡•Å",    romanized: "roknu",     meaning: "Stop / Pause" },
        { nepali: "‡§Æ‡§æ‡§•‡§ø",      romanized: "maathi",    meaning: "Up" },
        { nepali: "‡§§‡§≤",       romanized: "tala",      meaning: "Down" },
        { nepali: "‡§Ö‡§∞‡•ç‡§ï‡•ã",     romanized: "arko",      meaning: "Next" },
        { nepali: "‡§Ö‡§ò‡§ø‡§≤‡•ç‡§≤‡•ã",   romanized: "aghillo",   meaning: "Previous" },
        { nepali: "‡§´‡•á‡§∞‡§ø",      romanized: "feri",      meaning: "Repeat" },
        { nepali: "‡§†‡•Ä‡§ï ‡§õ",    romanized: "thik_chha", meaning: "Confirm / OK" },
        { nepali: "‡§π‡•Å‡§®‡•ç‡§õ",     romanized: "huncha",    meaning: "Yes" },
        { nepali: "‡§π‡•ã‡§á‡§®",      romanized: "hoina",     meaning: "No" },
    ];
    const MAX_ATTEMPTS = 10;
    const MIN_RECORD_MS = 700; // minimum 0.7 seconds for a valid clip

    /* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
    let currentUser   = null;
    let db, auth, provider;
    let CLOUDINARY_CLOUD = '';
    let CLOUDINARY_PRESET = '';

    // wordProgress: { romanized: attemptCount }  e.g. { banda: 4, gai: 10 }
    let wordProgress  = {};

    // Recorder state
    let activeWordIdx   = 0;   // which word is open in recorder
    let currentAttempt  = 0;   // local; derived from wordProgress on open
    let mediaRecorder   = null;
    let audioChunks     = [];
    let lastBlob        = null;
    let lastAudioURL    = null;
    let isRecording     = false;
    let currentAudio    = null;
    let recordStartTime = 0;

    /* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
    async function init() {
        try {
            const res = await fetch('/.netlify/functions/config');
            const { firebaseConfig, cloudinaryConfig } = await res.json();
            CLOUDINARY_CLOUD  = cloudinaryConfig.cloud;
            CLOUDINARY_PRESET = cloudinaryConfig.preset;

            const app = initializeApp(firebaseConfig);
            auth     = getAuth(app);
            provider = new GoogleAuthProvider();
            db       = getFirestore(app);

            getRedirectResult(auth).catch(e => showToast("Sign in error: " + e.message));

            onAuthStateChanged(auth, async user => {
                if (user) {
                    currentUser = user;
                    await saveUserProfile(user);
                    setupHeader(user);
                    await loadProgress(user);
                    showScreen('welcome');
                    document.getElementById('welcome-name').textContent = user.displayName || user.email;
                } else {
                    currentUser = null;
                    wordProgress = {};
                    showScreen('login');
                    document.getElementById('user-pill').style.display = 'none';
                }
            });
        } catch(e) {
            showToast("Failed to load config: " + e.message);
        }
    }

    init();

    /* ‚îÄ‚îÄ‚îÄ IN-APP BROWSER DETECTION ‚îÄ‚îÄ‚îÄ */
    function isInAppBrowser() {
        const ua = navigator.userAgent || '';
        return (
            ua.includes('FBAN') ||       // Facebook
            ua.includes('FBAV') ||       // Facebook
            ua.includes('FBIOS') ||      // Facebook iOS
            ua.includes('Instagram') ||  // Instagram
            ua.includes('Messenger') ||  // Messenger
            ua.includes('FB_IAB') ||     // Facebook in-app
            ua.includes('FB4A') ||       // Facebook Android
            (ua.includes('iPhone') && ua.includes('AppleWebKit') && !ua.includes('Safari')) // iOS in-app generic
        );
    }

    if (isInAppBrowser()) {
        const url = window.location.href;
        const ua = navigator.userAgent || '';

        if (/android/i.test(ua)) {
            // Android: fire intent immediately ‚Äî triggers Messenger's native "You're leaving our app" popup
            // If Chrome not installed falls back to any browser
            window.location.href = url.replace(/^https:\/\//, 'intent://') +
                '#Intent;scheme=https;action=android.intent.action.VIEW;package=com.android.chrome;S.browser_fallback_url=' + encodeURIComponent(url) + ';end';
        } else {
            // iOS: show our screen (iOS blocks auto-redirect from IAB)
            document.querySelectorAll('.screen').forEach(s => { s.style.display = 'none'; s.classList.remove('active'); });
            const iab = document.getElementById('iab-screen');
            iab.style.display = '';
            iab.classList.add('active');
            document.getElementById('iab-url-display').textContent = url;
        }
    }

    window.openInBrowser = () => {
        const url = window.location.href;
        const ua = navigator.userAgent || '';

        // Android: use intent:// to force open in default browser
        if (/android/i.test(ua)) {
            const intentUrl = url.replace('https://', 'intent://').replace('http://', 'intent://') +
                '#Intent;scheme=https;action=android.intent.action.VIEW;end';
            window.location.href = intentUrl;
            return;
        }

        // iOS: try opening with window.open which sometimes escapes IAB
        const newWin = window.open(url, '_blank');
        if (!newWin || newWin.closed) {
            // Blocked ‚Äî fall back to copy
            window.copyLink();
            showToast("Tap ‚ãØ menu ‚Üí Open in browser");
        }
    };

    window.copyLink = () => {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            showToast('Link copied! Paste it in Chrome or Safari');
        }).catch(() => {
            showToast('Copy this link: ' + url);
        });
    };

    /* ‚îÄ‚îÄ‚îÄ USER PROFILE ‚îÄ‚îÄ‚îÄ */
    async function saveUserProfile(user) {
        try {
            const ref  = doc(db, 'users', user.uid);
            const snap = await getDoc(ref);
            const now  = new Date();
            if (!snap.exists()) {
                await setDoc(ref, { uid: user.uid, name: user.displayName || '', email: user.email || '', photo: user.photoURL || '', joinedAt: now, lastSeen: now });
            } else {
                await setDoc(ref, { lastSeen: now }, { merge: true });
            }
        } catch(e) { console.error("Profile save failed:", e.message); }
    }

    function setupHeader(user) {
        document.getElementById('user-name-header').textContent = (user.displayName || user.email).split(' ')[0];
        const avatar = document.getElementById('user-avatar');
        if (user.photoURL) {
            avatar.innerHTML = `<img src="${user.photoURL}" alt="avatar"/>`;
        } else {
            avatar.textContent = (user.displayName || 'U')[0].toUpperCase();
        }
        document.getElementById('user-pill').style.display = 'flex';
    }

    /* ‚îÄ‚îÄ‚îÄ PROGRESS (per-word) ‚îÄ‚îÄ‚îÄ */
    async function loadProgress(user) {
        try {
            const snap = await getDoc(doc(db, 'users', user.uid, 'progress', 'words'));
            wordProgress = snap.exists() ? (snap.data() || {}) : {};
        } catch(e) {
            wordProgress = {};
        }
    }

    async function saveWordProgress(romanized, count) {
        if (!currentUser) return;
        try {
            wordProgress[romanized] = count;
            await setDoc(
                doc(db, 'users', currentUser.uid, 'progress', 'words'),
                wordProgress,
                { merge: true }
            );
        } catch(e) { showToast("Save failed: " + e.message); }
    }

    /* ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ */
    function totalClips() {
        return Object.values(wordProgress).reduce((s, v) => s + v, 0);
    }
    function completedWords() {
        return keywords.filter(kw => (wordProgress[kw.romanized] || 0) >= MAX_ATTEMPTS).length;
    }
    function allDone() {
        return completedWords() >= keywords.length;
    }

    /* ‚îÄ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ */
    function showScreen(name) {
        document.querySelectorAll('.screen').forEach(s => {
            s.classList.remove('active');
            s.style.display = 'none';
        });
        const target = document.getElementById(name + '-screen');
        target.style.display = '';
        target.classList.add('active');
    }

    /* ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ */
    window.goToStage = () => {
        renderStage();
        showScreen('stage');
    };

    window.signInWithGoogle = async () => {
        try {
            // Try popup first (works on most browsers)
            await signInWithPopup(auth, provider);
        } catch(e) {
            if (e.code === 'auth/popup-blocked' || e.code === 'auth/popup-closed-by-user') {
                // Fallback to redirect if popup blocked
                try { await signInWithRedirect(auth, provider); }
                catch(e2) { showToast("Sign in failed: " + e2.message); }
            } else {
                showToast("Sign in failed: " + e.message);
            }
        }
    };

    window.showLogoutModal  = () => { document.getElementById('logout-modal').style.display = 'flex'; };
    window.hideLogoutModal  = () => { document.getElementById('logout-modal').style.display = 'none'; };

    window.handleSignOut = async () => {
        hideLogoutModal();
        await signOut(auth);
        wordProgress = {};
    };

    window.handleDoneOK = () => {
        // Return to stage so they can see their completion, or restart
        renderStage();
        showScreen('stage');
    };

    /* ‚îÄ‚îÄ‚îÄ STAGE RENDER ‚îÄ‚îÄ‚îÄ */
    function renderStage() {
        const grid = document.getElementById('word-grid');
        grid.innerHTML = '';

        const done  = completedWords();
        const clips = totalClips();
        const pct   = Math.round((clips / (keywords.length * MAX_ATTEMPTS)) * 100);

        document.getElementById('stage-overall-label').textContent = `${done} / ${keywords.length} done`;
        document.getElementById('overall-bar').style.width = pct + '%';
        document.getElementById('overall-bar-label').textContent = `${clips} / ${keywords.length * MAX_ATTEMPTS} clips recorded`;

        // Show all-done banner
        const allDoneBanner = document.getElementById('stage-all-done');
        if (allDone()) {
            allDoneBanner.style.display = 'block';
        } else {
            allDoneBanner.style.display = 'none';
        }

        keywords.forEach((kw, idx) => {
            const count     = wordProgress[kw.romanized] || 0;
            const isDone    = count >= MAX_ATTEMPTS;
            const isPartial = count > 0 && !isDone;
            const fillPct   = Math.min(100, Math.round((count / MAX_ATTEMPTS) * 100));

            const tile = document.createElement('div');
            tile.className = 'word-tile' + (isDone ? ' completed' : isPartial ? ' in-progress' : '');

            tile.innerHTML = `
                <div class="tile-nepali">${kw.nepali}</div>
                <div class="tile-roman">${kw.romanized}</div>
                <div class="tile-meaning">${kw.meaning}</div>
                <div class="tile-progress-wrap">
                    <div class="tile-progress-fill ${isDone ? 'done' : 'partial'}" style="width:${fillPct}%"></div>
                </div>
                <div class="tile-progress-label">${count} / ${MAX_ATTEMPTS}</div>
            `;

            if (!isDone) {
                tile.onclick = () => openRecorder(idx);
            }

            grid.appendChild(tile);
        });
    }

    /* ‚îÄ‚îÄ‚îÄ OPEN RECORDER FOR A WORD ‚îÄ‚îÄ‚îÄ */
    window.openRecorder = (wordIdx) => {
        activeWordIdx  = wordIdx;
        currentAttempt = Math.min(wordProgress[keywords[wordIdx].romanized] || 0, MAX_ATTEMPTS);
        resetRecorderUI();
        showScreen('recorder');
    };

    function resetRecorderUI() {
        const kw      = keywords[activeWordIdx];
        const isDone  = currentAttempt >= MAX_ATTEMPTS;
        const wordNum = activeWordIdx + 1;

        document.getElementById('progress-text').textContent = `Attempt ${Math.min(currentAttempt + 1, MAX_ATTEMPTS)} of ${MAX_ATTEMPTS}`;
        document.getElementById('progress-fill').style.width = Math.round((currentAttempt / MAX_ATTEMPTS) * 100) + '%';
        document.getElementById('word-number').textContent    = `WORD ${wordNum} / ${keywords.length}`;
        document.getElementById('word-nepali').textContent    = kw.nepali;
        document.getElementById('word-romanized').textContent = kw.romanized;
        document.getElementById('word-meaning').textContent   = `"${kw.meaning}"`;
        document.getElementById('attempts-label').textContent = isDone
            ? `10 / 10 ‚Äî Complete! ‚úì`
            : `Attempt ${currentAttempt + 1} of ${MAX_ATTEMPTS}`;

        // Dots
        const row = document.getElementById('attempts-row');
        row.innerHTML = '';
        for (let i = 0; i < MAX_ATTEMPTS; i++) {
            const d = document.createElement('div');
            d.className = 'attempt-dot'
                + (i < currentAttempt ? ' done' : i === currentAttempt && !isDone ? ' active' : '');
            row.appendChild(d);
        }

        // Completed banner
        const banner = document.getElementById('word-completed-banner');
        banner.classList.toggle('show', isDone);

        // Record button ‚Äî disable if done
        const recordBtn = document.getElementById('record-btn');
        recordBtn.disabled = isDone;

        // Reset recording state
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        lastBlob = null;
        lastAudioURL = null;
        document.getElementById('record-btn').className = 'record-btn idle';
        document.getElementById('record-btn').textContent = 'üéô';
        document.getElementById('record-hint').textContent = isDone ? '‡¶∏‡§¨ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§™‡•Ç‡§∞‡§æ ‡§≠‡§è' : '‡§•‡§ø‡§ö‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§∞ ‡§¨‡•ã‡§≤‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç';
        document.getElementById('playback-row').style.display = 'none';
        document.getElementById('save-btn').disabled = false;
        document.getElementById('upload-indicator').classList.remove('show');
    }

    window.goBackToWelcome = () => {
        if (isRecording) stopRecording();
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        showScreen('welcome');
    };

    window.goBackToStage = async () => {
        if (isRecording) stopRecording();
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        renderStage();
        showScreen('stage');
        showToast("Progress saved!");
    };

    /* ‚îÄ‚îÄ‚îÄ RECORDING ‚îÄ‚îÄ‚îÄ */
    window.toggleRecord = async () => { isRecording ? stopRecording() : await startMic(); };

    async function startMic() {
        if (currentAttempt >= MAX_ATTEMPTS) { showToast("This word is complete!"); return; }
        try {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            // More permissive audio constraints for mobile browsers
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                }
            }).catch(async () => {
                // Fallback: try with minimal constraints if above fails
                return await navigator.mediaDevices.getUserMedia({ audio: true });
            });
            audioChunks  = [];
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const duration = Date.now() - recordStartTime;
                stream.getTracks().forEach(t => t.stop());
                document.getElementById('record-btn').className    = 'record-btn idle';
                document.getElementById('record-btn').textContent  = 'üéô';
                isRecording = false;

                if (duration < MIN_RECORD_MS) {
                    // Too short ‚Äî discard and prompt retry
                    lastBlob = null;
                    lastAudioURL = null;
                    document.getElementById('playback-row').style.display = 'none';
                    document.getElementById('record-hint').innerHTML =
                        '<span style="color:var(--red);font-weight:600"</span>';
                          '<span style="color:var(--red);font-weight:600">Didn&#39;t catch that clearly &#8212; say it again!</span>';
                    return;
                }

                lastBlob     = new Blob(audioChunks, { type: 'audio/webm' });
                lastAudioURL = URL.createObjectURL(lastBlob);
                document.getElementById('record-hint').textContent = '‡§∏‡•Å‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§µ‡§æ ‡§∏‡•á‡§≠ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§';
                document.getElementById('playback-row').style.display = 'flex';
            };
            mediaRecorder.start();
            recordStartTime = Date.now();
            isRecording = true;
            document.getElementById('record-btn').className   = 'record-btn recording';
            document.getElementById('record-btn').textContent = '‚èπ';
            document.getElementById('playback-row').style.display = 'none';

            document.getElementById('record-hint').textContent = '‡§∞‡•á‡§ï‡§∞‡•ç‡§° ‡§≠‡§á‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‚Ä¶';
        } catch(e) {
            if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                showToast('Mic blocked ‚Äî tap the lock icon in your browser and allow microphone');
            } else if (e.name === 'NotFoundError') {
                showToast('No microphone found on this device');
            } else {
                showToast('Mic error: ' + e.message);
            }
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    }

    window.playBack = () => {
        if (!lastAudioURL) { showToast("No recording to play"); return; }
        if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }
        currentAudio = new Audio(lastAudioURL);
        currentAudio.play().catch(e => showToast("Playback failed: " + e.message));
        currentAudio.onended = () => { currentAudio = null; };
    };

    window.retake = () => {
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        lastBlob = null; lastAudioURL = null;
        document.getElementById('playback-row').style.display = 'none';
        document.getElementById('record-hint').textContent = '‡§•‡§ø‡§ö‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§∞ ‡§¨‡•ã‡§≤‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç';
    };

    window.saveClip = async () => {
        if (!lastBlob || !currentUser) return;
        if (currentAttempt >= MAX_ATTEMPTS) { showToast("Already at 10/10!"); return; }
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }

        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;
        document.getElementById('upload-indicator').classList.add('show');

        const kw       = keywords[activeWordIdx];
        const speaker  = currentUser.uid + '_' + (currentUser.displayName || currentUser.email).replace(/\s+/g, '_');
        const keyword  = kw.romanized;
        const attemptNum = currentAttempt + 1;
        const filename = `${speaker}_${keyword}_attempt_${String(attemptNum).padStart(2, '0')}`;

        const formData = new FormData();
        formData.append('file', lastBlob, filename + '.webm');
        formData.append('upload_preset', CLOUDINARY_PRESET);
        formData.append('folder', `recordings/${speaker}/${keyword}`);
        formData.append('public_id', filename);

        try {
            const res  = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/video/upload`, { method: 'POST', body: formData });
            const data = await res.json();

            if (data.secure_url) {
                currentAttempt++;
                await saveWordProgress(keyword, currentAttempt);
                showToast("‚úì Saved!");

                if (currentAttempt >= MAX_ATTEMPTS) {
                    // Word done ‚Äî update UI, check if all done
                    resetRecorderUI();  // shows completed banner
                    document.getElementById('upload-indicator').classList.remove('show');

                    if (allDone()) {
                        await markAllComplete();
                        // Show done screen after brief delay
                        setTimeout(() => showFinalDone(), 800);
                    }
                } else {
                    resetRecorderUI();
                    document.getElementById('upload-indicator').classList.remove('show');
                }
            } else {
                throw new Error(data.error?.message || 'Upload failed');
            }
        } catch(e) {
            showToast("Upload failed: " + e.message);
            saveBtn.disabled = false;
            document.getElementById('upload-indicator').classList.remove('show');
        }
    };

    /* ‚îÄ‚îÄ‚îÄ DONE ‚îÄ‚îÄ‚îÄ */
    async function markAllComplete() {
        if (!currentUser) return;
        try {
            await setDoc(doc(db, 'users', currentUser.uid), {
                completedAt: new Date(),
                totalClips: totalClips()
            }, { merge: true });
        } catch(e) { console.error(e); }
    }

    window.showFinalDone = () => {
        document.getElementById('done-stats').innerHTML = `
            <div class="stat-row"><span>Speaker</span><span class="stat-val">${currentUser.displayName || currentUser.email}</span></div>
            <div class="stat-row"><span>Keywords</span><span class="stat-val">${keywords.length}</span></div>
            <div class="stat-row"><span>Clips</span><span class="stat-val">${totalClips()}</span></div>
            <div class="stat-row"><span>Saved</span><span class="stat-val">‚úì Yes</span></div>
        `;
        showScreen('done');
    };

    /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }

    // Expose to window
    window.showToast = showToast;
</script>
</body>
</html>
